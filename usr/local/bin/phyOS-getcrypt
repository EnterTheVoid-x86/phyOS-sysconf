#!/bin/sh

# cryptdev=$(lsblk -f -r | grep crypto_LUKS | awk '{print $1}' | while read d; do
#     cdev=$(lsblk -r /dev/$d | awk '{print $NF}' | grep -w "/" &> /dev/null && sudo cryptsetup luksUUID /dev/$d)
#     [[ ! -z $cdev ]] && echo $cdev && break
# done
# )
cryptdev=$(sudo dmsetup deps -o devname root | awk '{printf "/dev/";print $NF}' | tr -d "()" | sudo xargs cryptsetup luksUUID)

[[ $? != 0 ]] && exit 1
cryptdevice="    cryptdevice=UUID=$cryptdev:root"

sudo sed -i "36s/.*/$cryptdevice/" /usr/lib/initcpio/hooks/phy-encrypt
sudo sed -i "36s/.*/$cryptdevice/" /usr/lib/initcpio/hooks/phy-ply-encrypt
exit 0
